#!/bin/bash

# Run script as root $ sudo ./install
# Reboot required for I2C modules enable to take effect

# Part of the OpenEnergyMonitor.org project

echo "Enable I2C module"

#if ! grep -Fxq "BB-I2C1" /sys/devices/bone_capemgr.9/slots ; then
#       echo 'i2c 2 is not enabled, Enabling...'
#       sudo echo '@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots' >>tempcrontab.txt
#        echo 'i2c 2 now is enabled'
#
#else

#       echo 'i2c 2 already enabled'
#fi

cd /sys/devices/bone_capemgr.9/
file=slots

i2c_ports=`grep -c "BB-I2C1" "$file"`

if [ $i2c_ports -eq 1 ]
then
        echo "I2C 2 is already enabled"
else
        echo "i2c 2 is enabling..."
        sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots

fi
#---------------------------------------------------------------------------------------------
echo "Enable I2C on boot"

sudo touch /root/tempcrontab.txt
cd /root/
file=tempcrontab.txt

i2c_on_boot=`grep -c "@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots" "$file"`

if [ $i2c_on_boot -eq 1 ]
then
        echo "Code line exist"
        crontab -l >tempcrontab.txt
        #sudo echo '@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots' >> /root/tempcrontab.txt
        crontab tempcrontab.txt
else
        echo "Adding the code line....."
        crontab -l >tempcrontab.txt
        sudo echo '@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots' >> /root/tempcrontab.txt

        crontab tempcrontab.txt

fi

#---------------------------------------------------------------------------------------------------


echo 'Install Python I2C Tools'
sudo apt-get install python-smbus i2c-tools -y

echo 'Attemp to search for LCD I2C address:'
# Use port 2 for bbb
#sudo i2cdetect -r 2

echo 'Install emonPi Python LCD install scripts'

echo 'Install Python pip and uptime module'
#sudo apt-get update
sudo apt-get install build-essential python-dev python-smbus python-pip git
sudo pip install Adafruit_BBIO
sudo mkdir /home/lcdtest
if [ -f /home/lcdtest/lcddriver.py ]
then
        echo "lcd driver file already installed"
else
        cd /home/lcdtest/
        #download this configuration file inside this
        sudo wget https://raw.githubusercontent.com/GreatLakesEnergy/emonpi/beaglebone/lcd/lcddriver.py
        echo "lcd driver file addeded"

fi

if [ -f /home/lcdtest/i2c_lib.py ]
then
        echo "i2c library file already installed"
else
        cd /home/lcdtest/
        #download this configuration file inside this
        sudo wget https://raw.githubusercontent.com/GreatLakesEnergy/emonpi/beaglebone/lcd/i2c_lib.py
        echo "i2c library file addeded"

fi

if [ -f /home/lcdtest/lcd_test.py ]
then
        echo "lcd test file already installed"
else
        cd /home/lcdtest/
        #download this configuration file inside this
        sudo wget https://raw.githubusercontent.com/GreatLakesEnergy/emonpi/beaglebone/lcd/lcd_test.py
        echo "lcd test file addeded"
fi

echo 'I2C LCD installed...please reboot to take effect'

