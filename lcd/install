#!/bin/bash

# Run script as root $ sudo ./install
# Reboot required for I2C modules enable to take effect

# Part of the OpenEnergyMonitor.org project

echo "Enable I2C module"

#if ! grep -Fxq "BB-I2C1" /sys/devices/bone_capemgr.9/slots ; then
#       echo 'i2c 2 is not enabled, Enabling...'
#       sudo echo '@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots' >>tempcrontab.txt
#        echo 'i2c 2 now is enabled'
#
#else

#       echo 'i2c 2 already enabled'
#fi

cd /sys/devices/bone_capemgr.9/
file=slots

i2c_ports=`grep -c "BB-I2C1" "$file"`

if [ $i2c_ports -eq 1 ]
then
        echo "I2C 2 is already enabled"
else
        echo "i2c 2 is enabled"
        sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots

fi
#---------------------------------------------------------------------------------------------
echo "Enable I2C on boot"

sudo touch /root/tempcrontab.txt
cd /root/
file=tempcrontab.txt

i2c_on_boot=`grep -c "@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots" "$file"`

#enable i2c to be enabled on boot
if [ $i2c_on_boot -eq 1 ]
then

        echo "Code line exist"
        crontab -l >tempcrontab.txt
        #sudo echo '@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots' >> /root/tempcrontab.txt
        crontab tempcrontab.txt
else
        echo "Adding the code line....."
        crontab -l >tempcrontab.txt
        sudo echo '@reboot sudo echo BB-I2C1 >> /sys/devices/bone_capemgr.9/slots' >> /root/tempcrontab.txt
        crontab tempcrontab.txt

fi

#---------------------------------------------------------------------------------------------------
echo 'Install Python I2C Tools'
sudo apt-get install python-smbus i2c-tools -y

echo 'Attemp to search for LCD I2C address:'
# Use port 2 for bbb
#sudo i2cdetect -r 2
echo 'Install emonPi Python LCD install scripts'
echo 'Install Python pip and uptime module'
sudo apt-get update
sudo apt-get install build-essential python-dev python-smbus python-pip git
sudo pip install Adafruit_BBIO
echo 'I2C LCD installed...please reboot to take effect'

