---
   - name: update the repositories
     apt: update_cache=yes
   #Install basic packaged
   - name: Install Necessary packages
     apt: pkg={{item}} state=installed
     with_items:
     - vim
     - python-dev
     - python-smbus
     - python-pip
     - git
     - npm
     - redis-server
     - re
     - time
     - strace
     - minicom
     tags:
     - packages

   - name: install python packages
     action: pip state=present name={{ item }}
     with_items:
     - Adafruit_BBIO
     - uptime
     - paho-mqtt
     - redis
     tags:
     - pip-packages
        #make a directory
   - name: make local  directory
     file: path=/home/debian/emonpi state=directory


        #change permission of this config file 



      #Download EmonPi config files#
   - name: EmonPi Download
     git: repo=git://github.com/GreatLakesEnergy/emonpi.git version=beaglebone dest=/home/debian/emonpi/

   - name: Executable permission is assigned to LCD install file
     file: path=/home/debian/emonpi/lcd/install mode="u+x"

   - name: Executable permission is assigned to emonpi install file
     file: path=/home/debian/emonpi/install mode="u+x"

   - name: Executable permission is assigned  to emoncms9install file
     file: path=/home/debian/emonpi/emoncms9install mode="u+x"
  
   - name: Executable permission is assigned  to emonfirmwareinstall file
     file: path=/home/debian/emonpi/emonfirmwareinstall mode="u+x"


   - name: Executable permission is assigned to GPRS and Emon install file
     file: path=/home/debian/emonpi/gprs/gprsAndEmonTx.sh mode="u+x"
  

   - name: Executable permission is assigned to gprs_enable file
     file: path=/home/debian/emonpi/gprs/gprs_on.sh mode="u+x"


   - name: Executable permission is assigned to enable_ttyo4 file
     file: path=/home/debian/emonpi/gprs/enable_ttyo4.sh mode="u+x"


     #run GPRS and Emon  config file 
   - name: GPRS and EmonTX install file executed
     shell: "/home/debian/emonpi/gprs/gprsAndEmonTx.sh"
     args:
       chdir: "/home/debian/emonpi/gprs/"
       executable: "/bin/bash"
     tags:
       - gprs_install
     notify:
        - Update time


   - name: EmonCMS install file execute
     shell: "/home/debian/emonpi/emoncms9install"
     args:
       chdir: "/home/debian/emonpi/"
       executable: "/bin/bash"
     tags:
       - EmonCMS_install


    #run LCD config file
   - name: Install LCD drivers
     shell: "/home/debian/emonpi/install"
     args:
       chdir: "/home/debian/emonpi/"
       executable: "/bin/bash"
     notify: 
        - Restart EmonPiLCD
     tags:
       - lcd

   # Update TX firmware
   - name: Emon Firmware update and install
     shell: "/home/debian/emonpi/emonfirmwareinstall"
     args:
       chdir: "/home/debian/emonpi/"
     tags:
       - firmware
       
     notify:
       - start ntp
    

   - name: Configure EmonHub
     template: 
         src: "{{role_path}}/templates/emonhub.conf.j2"
         dest: "{{ emonhub_conf_dir }}/emonhub.conf"
     notify:
       - Restart Emonhub
     tags:
       - configure
